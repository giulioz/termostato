<!DOCTYPE html>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/bootstrap-reboot.min.css">
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/bootstrap-grid.min.css">
<link rel="stylesheet" href="css/bootstrap-toggle.min.css">
<link rel="stylesheet" href="css/bootstrap-slider.min.css">
<link rel="stylesheet" href="css/style.css">

<div class="container hidden">
    <h1>
        <i class="fa fa-fire"></i>
        <span id="headerHeading"></span>
        <span class="badge badge-secondary leftmargin">
            <small><i class="fa fa-thermometer"></i> <span id="tempPrint"></span></small>
        </span>
    </h1>

    <div class="btn-group" id="modeSelector">
        <button type="button" class="btn btn-secondary" id="on">Acceso</button>
        <button type="button" class="btn btn-secondary" id="off">Spento</button>
    </div>

    <input type="checkbox" data-toggle="toggle" id="autoCheckbox" data-on="Automatico" data-off="Manuale">

    <div class="row" id="auto">
        <div class="col">
            <table class="table table-striped table-sm">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Ora</th>
                        <th scope="col">Temperatura</th>
                    </tr>
                </thead>
                <tbody id="auto-table1">

                </tbody>
            </table>
        </div>
        <div class="col">
            <table class="table table-striped table-sm">
                <thead class="thead-light">
                <tr>
                    <th scope="col">Ora</th>
                    <th scope="col">Temperatura</th>
                </tr>
                </thead>
                <tbody id="auto-table2">

                </tbody>
            </table>
        </div>
    </div>
    <button type="button" class="btn btn-primary btn-block" id="sendTable">Invia</button>
</div>

<script>var locales = {};</script>
<script src="js/locale.it.js"></script>
<script src="js/config.js"></script>
<script src="js/ThermoInterface.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/bootstrap-toggle.min.js"></script>
<script src="js/bootstrap-slider.min.js"></script>
<script>

    var autoMode;

    // Check if login is needed
    ThermoInterface.get_login_mode().catch(function (error) {
        if (error.message === locale.error_noLogin) {
            location.href = "login.html";
        }
    }).then(function () {
        $(document).ready(function() {
            // Select current mode
            ThermoInterface.get_switching_mode().then(function (mode) {
                if (mode === "off" || mode === "on") {
                    if (mode === "on") {
                        $("#on").addClass("btn-primary").removeClass("btn-secondary");
                        $("#off").removeClass("btn-primary").addClass("btn-secondary");
                    } else {
                        $("#off").addClass("btn-primary").removeClass("btn-secondary");
                        $("#on").removeClass("btn-primary").addClass("btn-secondary");
                    }
                    $("#auto").addClass("hidden");
                    $("#on").removeClass("disabled");
                    $("#off").removeClass("disabled");

                    autoMode = false;
                } else {
                    $("#on").addClass("disabled");
                    $("#off").addClass("disabled");
                    if (mode === "auto_off") {
                        $("#off").addClass("btn-primary").removeClass("btn-secondary");
                        $("#on").removeClass("btn-primary").addClass("btn-secondary");
                    } else {
                        $("#on").addClass("btn-primary").removeClass("btn-secondary");
                        $("#off").removeClass("btn-primary").addClass("btn-secondary");
                    }
                    $("#auto").removeClass("hidden");

                    autoMode = true;
                }

                $("#autoCheckbox").bootstrapToggle(autoMode ? "on" : "off")
                    .change(function () {
                        if(this.checked) {
                            ThermoInterface.post_switching_mode("auto").then(function () {
                                $("#on").addClass("disabled");
                                $("#off").addClass("disabled");
                                $("#auto").removeClass("hidden");
                                autoMode = true;
                            });
                        } else {
                            ThermoInterface.post_switching_mode("off").then(function () {
                                $("#on").removeClass("disabled");
                                $("#off").removeClass("disabled");
                                $("#auto").addClass("hidden");
                                $("#off").addClass("btn-primary").removeClass("btn-secondary");
                                $("#on").removeClass("btn-primary").addClass("btn-secondary");
                                autoMode = false;
                            });
                        }
                    });
            }).then(function () {
                // Populate auto table
                ThermoInterface.get_auto_prog().then(function (data) {
                    for (var i = 0; i < 12; i++) {
                        document.getElementById("auto-table1").innerHTML +=
                            "<tr>" +
                            "<th scope=\"row\">" + i + ":00</th>" +
                            "<td>" +
                            "<input class='rightmargin' value='" + data[i] + "' id='C" + i + "' type=\"number\" step=\"0.5\">" +
                            "<input id=\"Cs" + i + "\" data-slider-id='Cs" + i + "Slider' type=\"text\" data-slider-min=\"10\" data-slider-max=\"30\" data-slider-step=\"1\" data-slider-value=\"" + data[i] + "\"/>" +
                            "</td>" +
                            "</tr>";
                        $('#Cs' + i).slider();
                    }
                    for (var i = 12; i < 24; i++) {
                        document.getElementById("auto-table2").innerHTML +=
                            "<tr>" +
                            "<th scope=\"row\">" + i + ":00</th>" +
                            "<td>" +
                            "<input class='rightmargin' value='" + data[i] + "' id='C" + i + "' type=\"number\" step=\"0.5\">" +
                            "<input id=\"Cs" + i + "\" data-slider-id='Cs" + i + "Slider' type=\"text\" data-slider-min=\"10\" data-slider-max=\"30\" data-slider-step=\"1\" data-slider-value=\"" + data[i] + "\"/>" +
                            "</td>" +
                            "</tr>";
                        $('#Cs' + i).slider();
                    }
                });
            }).then(function () {
                // Fill page title
                ThermoInterface.get_identifier().then(function (identifier) {
                    document.title = identifier;
                    $("#headerHeading").text(identifier);
                });
            }).then(function () {
                // Print room temp
                // TODO: make it dynamic
                ThermoInterface.temp().then(function (temp) {
                    $("#tempPrint").text(temp);
                });
            }).then(function () {
                $(".container").removeClass("hidden");
            });

            $("#on").click(function () {
                if (!autoMode) {
                    ThermoInterface.post_switching_mode("on").then(function () {
                        $("#on").addClass("btn-primary").removeClass("btn-secondary");
                        $("#off").removeClass("btn-primary").addClass("btn-secondary");
                    });
                }
            });

            $("#off").click(function () {
                if (!autoMode) {
                    ThermoInterface.post_switching_mode("off").then(function () {
                        $("#off").addClass("btn-primary").removeClass("btn-secondary");
                        $("#on").removeClass("btn-primary").addClass("btn-secondary");
                    });
                }
            });

            $("#sendTable").click(function () {
                var data = [];
                for (var i = 0; i < 24; i++) {
                    data.push(document.getElementById("C" + i).value);
                }
                ThermoInterface.post_auto_prog(data).then(function () { location.reload() });
            });
        })
    });

</script>
